{% extends 'base.html' %}
{% block title %}{{ _('Admin Dashboard') }}{% endblock %}
{% block content %}
  <h2 class="mb-4">{{ _('Admin Dashboard') }}</h2>
  
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'info' if category == 'info' else 'danger' if category == 'danger' else 'warning' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('admin.new_item') }}" class="btn btn-success">{{ _('Add New Item') }}</a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        {{ _('Sort by') }}: {% if current_sort == 'views' %}{{ _('Views') }}{% elif current_sort == 'name' %}{{ _('Name') }}{% elif current_sort == 'price' %}{{ _('Price') }}{% else %}{{ _('Date Created') }}{% endif %}
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='created_at') }}">{{ _('Date Created') }}</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='views') }}">{{ _('Most Viewed') }}</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='name') }}">{{ _('Name') }}</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='price') }}">{{ _('Price') }}</a></li>
      </ul>
    </div>
  </div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>{{ _('Name') }}</th>
        <th>{{ _('Price') }}</th>
        <th>{{ _('Views') }}</th>
        <th>{{ _('Sold') }}</th>
        <th>{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
        <tr>
          <td>{{ item.name }}</td>
          <td>{{ item.price | currency }}</td>
          <td>
            <span class="badge bg-info">{{ item.view_count or 0 }}</span>
          </td>
          <td>{{ _('Yes') if item.is_sold else _('No') }}</td>
          <td>
            <a href="{{ url_for('admin.edit_item', item_id=item.id) }}" class="btn btn-primary btn-sm">{{ _('Edit') }}</a>
            <form action="{{ url_for('admin.delete_item', item_id=item.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{{ _('Delete this item?') }}');">{{ _('Delete') }}</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row mt-5">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-users me-2"></i>Active Sessions
        </div>
        <div class="card-body">
          {% if active_sessions %}
            <p class="text-muted mb-3">You are currently logged in from {{ active_sessions|length }} device(s):</p>
            {% for session in active_sessions %}
              <div class="mb-2 p-2 bg-light rounded">
                <small>
                  <strong>IP:</strong> {{ session.ip_address or 'Unknown' }}<br>
                  <strong>Last Activity:</strong> {{ session.last_activity.strftime('%Y-%m-%d %H:%M') }}<br>
                  <strong>Browser:</strong> {{ session.user_agent[:30] }}{% if session.user_agent|length > 30 %}...{% endif %}
                </small>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No active sessions found.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-shield-alt me-2"></i>Security Alerts
        </div>
        <div class="card-body">
          {% if recent_failed_attempts %}
            <p class="text-muted mb-3">Recent failed login attempts:</p>
            {% for attempt in recent_failed_attempts %}
              <div class="mb-2 p-2 bg-danger bg-opacity-10 rounded">
                <small>
                  <strong>IP:</strong> {{ attempt.ip_address }}<br>
                  <strong>Username:</strong> {{ attempt.username or 'Unknown' }}<br>
                  <strong>Time:</strong> {{ attempt.attempted_at.strftime('%m-%d %H:%M') }}
                </small>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-success">No recent failed login attempts.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          Admin Navigation
        </div>
        <ul class="nav flex-column card-body">
          <li class="nav-item mb-2">
            <a class="nav-link p-0" href="{{ url_for('admin.dashboard') }}">
              <i class="fa fa-tachometer-alt"></i> Dashboard
            </a>
          </li>
          <li class="nav-item mb-2">
            <a class="nav-link p-0" href="{{ url_for('admin.site_settings') }}">
              <i class="fa fa-cog"></i> Site Settings
            </a>
          </li>
          <li class="nav-item mb-2">
            <a class="nav-link p-0" href="{{ url_for('admin.change_password') }}">
              <i class="fa fa-key"></i> Change Password
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link p-0" href="{{ url_for('admin.view_logs') }}">
              <i class="fa fa-file-alt"></i> View Logs
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
{% endblock %}
