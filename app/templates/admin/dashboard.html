{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
  <h2 class="mb-4">Admin Dashboard</h2>
  
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'info' if category == 'info' else 'danger' if category == 'danger' else 'warning' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('admin.new_item') }}" class="btn btn-success">Add New Item</a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Sort by: {% if current_sort == 'views' %}Views{% elif current_sort == 'name' %}Name{% elif current_sort == 'price' %}Price{% else %}Date Created{% endif %}
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='created_at') }}">Date Created</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='views') }}">Most Viewed</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='name') }}">Name</a></li>
        <li><a class="dropdown-item" href="{{ url_for('admin.dashboard', sort='price') }}">Price</a></li>
      </ul>
    </div>
  </div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Views</th>
        <th>Sold</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
        <tr>
          <td>{{ item.name }}</td>
          <td>${{ '%.2f' | format(item.price) }}</td>
          <td>
            <span class="badge bg-info">{{ item.view_count or 0 }}</span>
          </td>
          <td>{{ 'Yes' if item.is_sold else 'No' }}</td>
          <td>
            <a href="{{ url_for('admin.edit_item', item_id=item.id) }}" class="btn btn-primary btn-sm">Edit</a>
            <form action="{{ url_for('admin.delete_item', item_id=item.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this item?');">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row mt-5">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-users me-2"></i>Active Sessions
        </div>
        <div class="card-body">
          {% if active_sessions %}
            <p class="text-muted mb-3">You are currently logged in from {{ active_sessions|length }} device(s):</p>
            {% for session in active_sessions %}
              <div class="mb-2 p-2 bg-light rounded">
                <small>
                  <strong>IP:</strong> {{ session.ip_address or 'Unknown' }}<br>
                  <strong>Last Activity:</strong> {{ session.last_activity.strftime('%Y-%m-%d %H:%M') }}<br>
                  <strong>Browser:</strong> {{ session.user_agent[:50] }}{% if session.user_agent|length > 50 %}...{% endif %}
                </small>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No active sessions found.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          Admin Navigation
        </div>
        <ul class="nav flex-column card-body">
          <li class="nav-item mb-2">
            <a class="nav-link p-0" href="{{ url_for('admin.dashboard') }}">
              <i class="fa fa-tachometer-alt"></i> Dashboard
            </a>
          </li>
          <li class="nav-item mb-2">
            <a class="nav-link p-0" href="{{ url_for('admin.site_settings') }}">
              <i class="fa fa-cog"></i> Site Settings
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link p-0" href="{{ url_for('admin.change_password') }}">
              <i class="fa fa-key"></i> Change Password
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
{% endblock %}
